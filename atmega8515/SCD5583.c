#include "SCD5583.h"

const uint8 char_table[] PROGMEM = {
    0x00U, 0x20U, 0x40U, 0x60U, 0x80U, /*   */
    0x04U, 0x24U, 0x44U, 0x60U, 0x84U, /* ! */
    0x0AU, 0x2AU, 0x40U, 0x60U, 0x80U, /* " */
    0x0AU, 0x3FU, 0x4AU, 0x7FU, 0x8AU, /* # */
    0x0FU, 0x34U, 0x4EU, 0x65U, 0x9EU, /* $ */
    0x19U, 0x3AU, 0x44U, 0x6BU, 0x93U, /* % */
    0x08U, 0x34U, 0x4DU, 0x72U, 0x8DU, /* & */
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U, /* ' */
    0x02U, 0x24U, 0x44U, 0x64U, 0x82U, /* ( */
    0x08U, 0x24U, 0x44U, 0x64U, 0x88U, /* ) */
    0x15U, 0x2EU, 0x5FU, 0x6EU, 0x95U, /* * */
    0x04U, 0x24U, 0x5FU, 0x64U, 0x84U, /* + */
    0x00U, 0x2CU, 0x4CU, 0x64U, 0x88U, /* , */
    0x00U, 0x20U, 0x5FU, 0x60U, 0x80U, /* - */
    0x00U, 0x20U, 0x40U, 0x6CU, 0x8CU, /* . */
    0x01U, 0x22U, 0x44U, 0x68U, 0x90U, /* / */
    0x0EU, 0x33U, 0x55U, 0x79U, 0x8EU, /* 0 */
    0x04U, 0x2CU, 0x44U, 0x64U, 0x8EU, /* 1 */
    0x0EU, 0x31U, 0x46U, 0x68U, 0x9FU, /* 2 */
    0x1EU, 0x21U, 0x4EU, 0x61U, 0x9EU, /* 3 */
    0x06U, 0x2AU, 0x5FU, 0x62U, 0x82U, /* 4 */
    0x1FU, 0x30U, 0x5EU, 0x61U, 0x9EU, /* 5 */
    0x06U, 0x28U, 0x5EU, 0x71U, 0x8EU, /* 6 */
    0x1FU, 0x22U, 0x44U, 0x68U, 0x88U, /* 7 */
    0x0EU, 0x31U, 0x4EU, 0x71U, 0x8EU, /* 8 */
    0x0EU, 0x31U, 0x4FU, 0x62U, 0x8CU, /* 9 */
    0x0CU, 0x2CU, 0x40U, 0x6CU, 0x8CU, /* : */
    0x04U, 0x24U, 0x40U, 0x64U, 0x84U, /* ; */
    0x02U, 0x24U, 0x48U, 0x64U, 0x82U, /* < */
    0x00U, 0x3FU, 0x40U, 0x7FU, 0x80U, /* = */
    0x08U, 0x24U, 0x42U, 0x64U, 0x88U, /* > */
    0x0EU, 0x31U, 0x42U, 0x64U, 0x84U, /* ? */
    0x0EU, 0x35U, 0x57U, 0x70U, 0x8EU, /* @ */
    0x04U, 0x2AU, 0x5FU, 0x71U, 0x91U, /* A */
    0x1EU, 0x29U, 0x4EU, 0x69U, 0x9EU, /* B */
    0x0FU, 0x30U, 0x50U, 0x70U, 0x8FU, /* C */
    0x1EU, 0x29U, 0x49U, 0x69U, 0x9EU, /* D */
    0x1FU, 0x30U, 0x5EU, 0x70U, 0x9FU, /* E */
    0x1FU, 0x30U, 0x5EU, 0x70U, 0x90U, /* F */
    0x0FU, 0x30U, 0x53U, 0x71U, 0x8FU, /* G */
    0x11U, 0x31U, 0x5FU, 0x71U, 0x91U, /* H */
    0x0EU, 0x24U, 0x44U, 0x64U, 0x8EU, /* I */
    0x01U, 0x21U, 0x41U, 0x71U, 0x8EU, /* J */
    0x13U, 0x34U, 0x58U, 0x74U, 0x93U, /* K */
    0x10U, 0x30U, 0x50U, 0x70U, 0x9FU, /* L */
    0x11U, 0x3BU, 0x55U, 0x71U, 0x91U, /* M */
    0x11U, 0x39U, 0x55U, 0x73U, 0x91U, /* N */
    0x0EU, 0x31U, 0x51U, 0x71U, 0x8EU, /* O */
    0x1EU, 0x31U, 0x5EU, 0x70U, 0x90U, /* P */
    0x0CU, 0x32U, 0x56U, 0x72U, 0x8DU, /* Q */
    0x1EU, 0x31U, 0x5EU, 0x74U, 0x92U, /* R */
    0x0FU, 0x30U, 0x4EU, 0x61U, 0x9EU, /* S */
    0x1FU, 0x24U, 0x44U, 0x64U, 0x84U, /* T */
    0x11U, 0x31U, 0x51U, 0x71U, 0x8EU, /* U */
    0x11U, 0x31U, 0x51U, 0x6AU, 0x84U, /* V */
    0x11U, 0x31U, 0x55U, 0x7BU, 0x91U, /* W */
    0x11U, 0x2AU, 0x44U, 0x6AU, 0x91U, /* X */
    0x11U, 0x2AU, 0x44U, 0x64U, 0x84U, /* Y */
    0x1FU, 0x22U, 0x44U, 0x68U, 0x9FU, /* Z */
    0x07U, 0x24U, 0x44U, 0x64U, 0x87U, /* [ */
    0x10U, 0x28U, 0x44U, 0x62U, 0x81U, /* \ */
    0x1CU, 0x24U, 0x44U, 0x64U, 0x9CU, /* ] */
    0x04U, 0x2AU, 0x51U, 0x60U, 0x80U, /* ^ */
    0x00U, 0x20U, 0x40U, 0x60U, 0x9FU, /* _ */
    0x04U, 0x24U, 0x40U, 0x60U, 0x80U, /* ' */
    0x00U, 0x2EU, 0x52U, 0x72U, 0x8DU, /* a */
    0x10U, 0x30U, 0x5EU, 0x71U, 0x9EU, /* b */
    0x00U, 0x2FU, 0x50U, 0x70U, 0x8FU, /* c */
    0x01U, 0x21U, 0x4FU, 0x71U, 0x8FU, /* d */
    0x00U, 0x2EU, 0x5FU, 0x70U, 0x8EU, /* e */
    0x06U, 0x28U, 0x48U, 0x7CU, 0x88U, /* f */
    0x00U, 0x2FU, 0x50U, 0x73U, 0x8FU, /* g */
    0x10U, 0x30U, 0x56U, 0x79U, 0x91U, /* h */
    0x04U, 0x20U, 0x4CU, 0x64U, 0x8EU, /* i */
    0x00U, 0x26U, 0x42U, 0x72U, 0x8CU, /* j */
    0x10U, 0x30U, 0x56U, 0x78U, 0x96U, /* k */
    0x0CU, 0x24U, 0x44U, 0x64U, 0x8EU, /* l */
    0x00U, 0x2AU, 0x55U, 0x75U, 0x95U, /* m */
    0x00U, 0x36U, 0x59U, 0x71U, 0x91U, /* n */
    0x00U, 0x2EU, 0x51U, 0x71U, 0x8EU, /* o */
    0x00U, 0x3EU, 0x51U, 0x7EU, 0x90U, /* p */
    0x00U, 0x2FU, 0x51U, 0x6FU, 0x81U, /* q */
    0x00U, 0x36U, 0x58U, 0x70U, 0x90U, /* r */
    0x00U, 0x23U, 0x44U, 0x62U, 0x8CU, /* s */
    0x08U, 0x3CU, 0x48U, 0x68U, 0x86U, /* t */
    0x00U, 0x32U, 0x52U, 0x72U, 0x8DU, /* u */
    0x00U, 0x31U, 0x51U, 0x6AU, 0x84U, /* v */
    0x00U, 0x31U, 0x55U, 0x7BU, 0x91U, /* w */
    0x00U, 0x32U, 0x4CU, 0x6CU, 0x92U, /* x */
    0x00U, 0x31U, 0x4AU, 0x64U, 0x98U, /* y */
    0x00U, 0x3EU, 0x44U, 0x68U, 0x9EU, /* z */
    0x06U, 0x24U, 0x48U, 0x64U, 0x86U, /* { */
    0x04U, 0x24U, 0x44U, 0x64U, 0x84U, /* | */
    0x0CU, 0x24U, 0x42U, 0x64U, 0x8CU, /* } */
    0x08U, 0x35U, 0x42U, 0x60U, 0x80U, /* ~ */
    0x00U, 0x00U, 0x00U, 0x00U, 0x00U  /* \ */
};

static char disp_line[16];
static uint8 char_pos;

uint8 disp_wr(uint8 dispnr, uint8 data) {
    uint8 loadnr, i;
    loadnr = !dispnr ? LOAD_0_PIN: LOAD_1_PIN;
    PORTA &= (uint8)~(1 << loadnr);
    PORTA &= (uint8)~(1 << SDCLK_PIN);
    for (i = 0; i < 8; i++) {
        if (data & 1)
            PORTA |= (uint8)(1 << SDATA_PIN);
        else
            PORTA &= (uint8)~(1 << SDATA_PIN);
        wait_loop(SDCLK_T);
        PORTA |= (uint8)(1 << SDCLK_PIN);
        wait_loop(SDCLK_T);
        PORTA &= (uint8)~(1 << SDCLK_PIN);
        data >>= 1;
    }
    wait_loop(SDCLK_T);
    PORTA |= (uint8)(1 << loadnr);
    return 0;
}

uint8 disp_wrline(void) {
    uint8 i, dispnr, index, j, data;
    const uint8 limit = sizeof(disp_line)/sizeof(disp_line[0]);
    for (i = 0; i < limit; i++) {
        dispnr = i < 8 ? 0: 1;
        disp_wr(dispnr, (i % 8) | 0xA0);
        index = disp_line[i];
        if (index >= 32 && index <= 127) {
            index -= 32;
            for (j = 0; j < 5; j++) {
                data = pgm_read_byte_near(&char_table[5 * index + j]);
                disp_wr(dispnr, data);
            }
        } else {
            data = pgm_read_byte_near(char_table[0]);
            for (j = 0; j < 5; j++) disp_wr(dispnr, data);
        }
    }
    return 0;
}


uint8 wait_loop(uint16 max) {
    uint16 i;
    for (i = 0; i < max; i++);
    return i;
}

uint8 disp_printf(const char *str) {
    uint8 i;
    const uint8 limit = sizeof(disp_line)/sizeof(disp_line[0]);
    while (*str) {
        if (char_pos > limit - 1) {
            char_pos = limit - 1;
            for (i = 1; i < limit; i++)
                disp_line[i - 1] = disp_line[i];
        }
        disp_line[char_pos] = *str++;
        char_pos++;
    }
    return disp_wrline();
}

uint8 clear_disp(void) {
    uint8 i;
    const uint8 limit = sizeof(disp_line)/sizeof(disp_line[0]);
    for (i = 0; i < limit; i++) disp_line[i] = ' ';
    char_pos = 0;
    return disp_wr(0, 0xC0) | disp_wr(1, 0xC0);
}

uint8 disp_rst(void) {
    PORTA &= (uint8)~(1 << RST_PIN);
    wait_loop(65535);
    PORTA |= (uint8)(1 << RST_PIN);
    wait_loop(65535);
    return 0;
}
